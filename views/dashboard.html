<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AcademiaLMS</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/dashboard.css">
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <span>Academia<span class="logo-highlight">LMS</span></span>
        </div>
        <nav class="admin-nav" id="nav-links"></nav>
        <button class="btn-logout" id="btn-logout">
            <i class="fas fa-sign-out-alt"></i><span>D√©connexion</span>
        </button>
    </aside>

    <main class="main-content">
        <!-- Dashboard √âtudiant ‚úÖ -->
        <section class="tab-content" id="dash-etudiant" style="display:none;">
            <div class="header">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard √âtudiant</h2>
            </div>
            <div class="stats-section">
                <h3>Vos statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-book"></i></div><h4>Cours Actifs</h4><p id="cours-actifs">12</p></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-clock"></i></div><h4>Heures Compl√©t√©es</h4><p>45h</p></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-star"></i></div><h4>Moyenne</h4><p>4.8/5</p></div>
                </div>
            </div>
        </section>

        <!-- Cours √âtudiant  -->
        <section class="tab-content" id="cours" style="display:none;">
            <div class="header"><h2><i class="fas fa-book-open"></i> Mes Cours</h2></div>
            <div id="liste-etudiant"><div class="loading-spinner">Chargement de vos cours...</div></div>
        </section>

        <!-- Explorer √âtudiant ‚úÖ -->
        <section class="tab-content" id="explorer" style="display:none;">
            <div class="header">
                <h2>Explorer Cours</h2>
                <div class="header-actions">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Rechercher un cours..." class="search-input" id="explorer-search">
                    </div>
                    <select class="filterSelect" id="explorer-niveau">
                        <option value="">Tous les niveaux</option>
                        <option value="d√©butant">D√©butant</option>
                        <option value="interm√©diaire">Interm√©diaire</option>
                        <option value="avanc√©">Avanc√©</option>
                    </select>
                </div>
            </div>
            <div id="explorer-liste"><div class="loading-spinner">Chargement des cours...</div></div>
        </section>

        <!-- Dashboard Professeur -->
        <section class="tab-content" id="dash-prof" style="display:none;">
            <div class="header"><h2><i class="fas fa-chalkboard-teacher"></i> Dashboard Professeur</h2></div>
            <div class="stats-section">
                <h3>Statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-book"></i></div><h4>Cours Cr√©√©s</h4><p>8</p></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div><h4>√âtudiants</h4><p>247</p></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-euro-sign"></i></div><h4>Revenus</h4><p>‚Ç¨1,240</p></div>
                </div>
            </div>
        </section>

        <!-- Gestion Cours CRUD Prof -->
        <section class="tab-content" id="cours-crud" style="display:none;">
            <div class="header">
                <h2>Gestion des Cours</h2>
                <div class="header-actions">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Rechercher un cours..." class="search-input" id="prof-search">
                    </div>
                </div>
                <a href="./professeur/cours.html" class="add-course-btn">
                    <i class="fas fa-plus"></i> Nouveau cours
                </a>
            </div>
            <div id="liste"><div class="loading-spinner">Chargement de vos cours...</div></div>
        </section>

        <!-- Compte -->
    <section class="tab-content" id="compte" style="display:none;">
        <div class="header"><h2><i class="fas fa-user-circle"></i> Mon Compte</h2></div>
        <div class="account-section">
            <div id="view-profile">
                <div class="account-avatar"><i class="fas fa-user"></i></div>
                <div class="account-info">
                    <h3 id="user-name">Chargement...</h3>
                    <p class="account-email" id="user-email">-</p>
                </div>
                <div class="account-details">
                    <div class="detail-row"><label>T√©l√©phone</label><span id="user-phone">-</span></div>
                    <div class="detail-row"><label>R√¥le</label><span id="user-role">-</span></div>
                    <div class="detail-row"><label>Date d'inscription</label><span id="user-join">-</span></div>
                </div>
                <button class="add-course-btn" onclick="toggleEditProfile(true)" style="margin-top: 20px; width: 100%;">
                    <i class="fas fa-edit"></i> Modifier mon profil
                </button>
            </div>

            <form id="form-edit-profile" style="display:none;" class="account-details">
                <div class="detail-row"><label>Nom</label><input type="text" id="edit-nom" class="search-input"></div>
                <div class="detail-row"><label>Pr√©nom</label><input type="text" id="edit-prenom" class="search-input"></div>
                <div class="detail-row"><label>T√©l√©phone</label><input type="text" id="edit-tel" class="search-input"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="add-course-btn" style="background: #27ae60;">Enregistrer</button>
                    <button type="button" class="add-course-btn" style="background: #e74c3c;" onclick="toggleEditProfile(false)">Annuler</button>
                </div>
            </form>
        </div>
    </section>
    </main>

    <script>
        let currentUser = null;
        let isLoadingUser = true;
        let allExplorerCourses = [];
        let allProfCourses = [];

        // üîÑ Fetch user data
        async function fetchUserData() {
            try {
                const response = await fetch('/user-info', { credentials: 'include' });
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    console.log('‚úÖ User charg√©:', currentUser);
                } else {
                    window.location.href = '/user/login';
                    return;
                }
            } catch (error) {
                console.error('‚ùå Erreur fetch user:', error);
                window.location.href = '/user/login';
                return;
            }
            isLoadingUser = false;
            initializeDashboard();
        }

        // Navigation
        function setNavLinks(roles_id) {
            const navLinks = document.getElementById('nav-links');
            if (roles_id === 1) {
                navLinks.innerHTML = `
                    <a href="#" class="nav-link active" data-tab="dash-etudiant"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                    <a href="#" class="nav-link" data-tab="cours"><i class="fas fa-book-open"></i><span>Cours</span></a>
                    <a href="#" class="nav-link" data-tab="explorer"><i class="fas fa-search"></i><span>Explorer</span></a>
                    <a href="#" class="nav-link" data-tab="compte"><i class="fas fa-user-circle"></i><span>Compte</span></a>
                `;
            } else if (roles_id === 2) {
                navLinks.innerHTML = `
                    <a href="#" class="nav-link active" data-tab="dash-prof"><i class="fas fa-chalkboard-teacher"></i><span>Dashboard</span></a>
                    <a href="#" class="nav-link" data-tab="cours-crud"><i class="fas fa-book"></i><span>Gestion Cours</span></a>
                    <a href="#" class="nav-link" data-tab="compte"><i class="fas fa-user-circle"></i><span>Compte</span></a>
                `;
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = tab.id === tabId ? 'block' : 'none';
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tabId);
            });
        }

        function showUserInfo(user) {
            document.getElementById('user-name').textContent = `${user.nom} ${user.prenom}`;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-phone').textContent = user.tel || '-';
            document.getElementById('user-role').textContent = user.roles_id === 1 ? '√âtudiant' : 'Professeur';
            document.getElementById('user-join').textContent = user.joined_at ? new Date(user.joined_at).toLocaleDateString('fr-FR') : '-';

        }

        // ‚úÖ COURSE ACTIONS COMPL√àTES - Inscription marche parfaitement
        function courseActions() {
            // 1. INSCRIPTION (√©tudiant) ‚úÖ
            document.querySelectorAll('.btn-reg').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const coursId = e.currentTarget.dataset.id;
                    
                    try {
                        const response = await fetch('/etudiant/inscription', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cours_id: coursId }),
                            credentials: 'include'
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('‚úÖ Inscription r√©ussie !');
                            if (document.querySelector('#cours') || document.querySelector('#explorer')) {
                                await fetchCoursEtudiant();
                            }
                        } else {
                            alert('‚ùå ' + (data.message || 'Erreur inscription'));
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur inscription:', error);
                        alert('‚ùå Erreur r√©seau');
                    }
                });
            });

            // 2. SUPPRIMER (prof)
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    if (!confirm('Supprimer d√©finitivement ce cours ?')) return;
                    
                    const coursId = e.currentTarget.dataset.id;
                    try {
                        const response = await fetch(`/cours/${coursId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        
                        if (response.ok || response.status === 204) {
                            allProfCourses = allProfCourses.filter(c => c.id != coursId);
                            renderProfCourses(allProfCourses, document.getElementById('liste'));
                            alert('‚úÖ Cours supprim√© !');
                        } else {
                            throw new Error('Erreur serveur');
                        }
                    } catch (error) {
                        alert('‚ùå Erreur suppression');
                    }
                });
            });

            // 3. MODIFIER (prof)
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const coursId = e.currentTarget.dataset.id;
                    const cours = allProfCourses.find(c => c.id == coursId);
                    if (cours) {
                        sessionStorage.setItem('editCours', JSON.stringify(cours));
                        window.location.href = `/professeur/cours?edit=${coursId}`;
                    }
                });
            });
            // 4. MODIFICATION USER INFO
            // document.querySelectorAll('.btn--edit').forEach(btn => {
            //     btn.addEventListener('click', (e) => {
            //         const usersId = e.currentTarget.dataset.id;
            //         const user = allUsers.find(u => u.id == usersId);
            //          if (users) {
            //             sessionStorage.setItem('editUsers', JSON.stringify(user));
            //             window.location.href = `/users?edit=${usersId}`;
            //         }
                    
            //     })
            // })
        }

        // üìö Fetch cours prof
        async function fetchCoursProf() {
            try {
                const res = await fetch('/professeur/cours-list', { credentials: 'include' });
                const data = await res.json();
                const container = document.getElementById('liste');
                
                if (!data.success || !data.cours?.length) {
                    container.innerHTML = '<p class="no-data">Aucun cours pour le moment.</p>';
                    return;
                }
                allProfCourses = data.cours;
                renderProfCourses(allProfCourses, container);
            } catch (e) {
                console.error('‚ùå fetchCoursProf:', e);
                document.getElementById('liste').innerHTML = '<p class="no-data">Erreur chargement.</p>';
            }
        }

        // ‚úÖ Fetch cours √©tudiant  - R√©cup√®re TOUS les cours + INSCRIPTIONS
        async function fetchCoursEtudiant() {
            try {
             const res = await fetch('/etudiant/cours-list', { credentials: 'include' });
                const data = await res.json();
                const container = document.getElementById('liste-etudiant');
                
                if (!data.success || !data.inscriptions?.length) {
                    container.innerHTML = '<p class="no-data">Aucun cours inscrit pour le moment.</p>';
                    return;
                }
                allEtudiantCourses = data.inscriptions;
                renderEtudiantCourses(allEtudiantCourses, container);
            } catch (e) {
                console.error('‚ùå fetchCoursEtudiant:', e);
                document.getElementById('liste-etudiant').innerHTML = '<p class="no-data">Erreur chargement.</p>';
            }

        }

        async function fetchCours() {
            try {
                const res = await fetch('/cours-list', { credentials: 'include' });
                const data = await res.json();
                
                const explorerContainer = document.getElementById('explorer-liste');
                
                if (!data.success || !data.cours?.length) {
                    explorerContainer.innerHTML = '<p class="no-data">Aucun cours disponible.</p>';
                    return;
                }
                
                allExplorerCourses = data.cours;
                renderExplorerCourses(allExplorerCourses, explorerContainer);
                              
            } catch (e) {
                console.error('‚ùå fetchCours:', e);
            }
        }
        // üé® Render prof courses
        function renderProfCourses(coursList, container) {
            container.innerHTML = '';
            if (!coursList.length) {
                container.innerHTML = '<p class="no-data">Aucun cours trouv√©.</p>';
                return;
            }
            const grid = document.createElement('div');
            grid.className = 'cours-grid';
            coursList.forEach(cours => {
                const card = document.createElement('div');
                card.className = 'cours-card';
                card.innerHTML = `
                    <h3>${cours.titre_cours}</h3>
                    <p class="desc">${cours.desc_cours || ''}</p>
                    <div class="meta">
                        <span>${cours.duree_minutes || 0} min</span>
                        <span>${cours.prix || 0} Fcfa</span>
                    </div>
                    <div class="meta">
                        <span>√âtudiants: ${cours.total_etudiants || 0}</span>
                        <span>Note: ${cours.note_moyenne ?? 0}/5</span>
                    </div>
                    <div class="actions">
                        <button class="btn-small btn-edit" data-id="${cours.id}">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="btn-small btn-delete" data-id="${cours.id}">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
            container.appendChild(grid);
            courseActions(); // ‚úÖ R√©attacher les event listeners
        }

        // ‚úÖ Render MES COURS √âTUDIANT 
        function renderEtudiantCourses(mesCours, container) {
            container.innerHTML = '';
            if (!mesCours?.length) {
                container.innerHTML = '<p class="no-data">Aucun cours inscrit. <a href="#explorer">Explorer les cours</a></p>';
                return;
            }
            
            const grid = document.createElement('div');
            grid.className = 'cours-grid';
            
            mesCours.forEach(cours => {
                const card = document.createElement('div');
                card.className = 'cours-card';
                card.innerHTML = `
                    <h3>${cours.titre_cours}</h3>
                    <p class="desc">${cours.desc_cours || ''}</p>
                    <div class="meta">
                        <span>${cours.duree_minutes || 0} min</span>
                        <span>${formatPrice(cours.prix || 0)} Fcfa</span>
                    </div>
                    <div class="meta">
                        <span>Progression: ${cours.pourcentage_progression ?? 0}%</span>
                        <span>Note: ${cours.note_moyenne ?? 0}/5</span>
                    </div>
                    <div class="actions">
                        <a href="/etudiant/cours/${cours.id}" class="btn-small">
                            <i class="fas fa-play-circle"></i> Continuer le cours
                        </a>
                    </div>
                `;
                grid.appendChild(card);
            });
            container.appendChild(grid);
        }

        //Update du user
        function toggleEditProfile(show) {
            document.getElementById('view-profile').style.display = show ? 'none' : 'block';
            document.getElementById('form-edit-profile').style.display = show ? 'block' : 'none';
            
            if (show) {
                document.getElementById('edit-nom').value = currentUser.nom;
                document.getElementById('edit-prenom').value = currentUser.prenom;
                document.getElementById('edit-tel').value = currentUser.tel || '';
            }
        }

        // G√©rer la soumission du formulaire
        document.getElementById('form-edit-profile').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const updatedData = {
        nom: document.getElementById('edit-nom').value,
        prenom: document.getElementById('edit-prenom').value,
        tel: document.getElementById('edit-tel').value
    };

    try {
        // CORRECTION ICI : Ajout de method, headers et body
        const response = await fetch('/user/update', { 
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData),
            credentials: 'include' 
        });

        const data = await response.json();

        if (data.success) {
            alert('‚úÖ Profil mis √† jour !');
            currentUser.nom = updatedData.nom;
            currentUser.prenom = updatedData.prenom;
            currentUser.tel = updatedData.tel;
            
            showUserInfo(currentUser);
            toggleEditProfile(false);
        } else {
            alert('‚ùå Erreur: ' + data.message);
        }
    } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå Erreur r√©seau ou r√©ponse serveur invalide');
    }
});

        // üé® Render explorer ‚úÖ
        function renderExplorerCourses(coursList, container) {
            container.innerHTML = '';
            if (!coursList.length) {
                container.innerHTML = '<p class="no-data">Aucun cours trouv√©.</p>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'explorer-grid';
            coursList.forEach(cours => {
                const card = document.createElement('div');
                card.className = 'explorer-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="rating">${generateStars(cours.note_moyenne ?? 0)}
                            <span class="rating-text">(${cours.note_moyenne ?? 0}/5)</span>
                        </div>
                    </div>
                    <h3 class="course-title">${cours.titre_cours}</h3>
                    <p class="course-desc">${cours.desc_cours || 'Description du cours...'}</p>
                    <div class="course-meta">
                        <div class="prof-info">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>${cours.nom_professeur} ${cours.prenom_professeur}</span>
                        </div>
                        <div class="course-stats">
                            <span class="duration"><i class="fas fa-clock"></i> ${cours.duree_minutes || 0}min</span>
                            <span class="price">${formatPrice(cours.prix || 0)} Fcfa</span>
                            <span class="students"><i class="fas fa-users"></i> ${cours.total_etudiants || 0}</span>
                        </div>
                    </div>
                    <button class="btn-reg" data-id="${cours.id}">
                        <i class="fas fa-play-circle"></i> S'inscrire
                    </button>`;
                grid.appendChild(card);
            });
            container.appendChild(grid);
            courseActions(); // ‚úÖ R√©attacher apr√®s rendu
        }
        
        function generateStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalf = rating % 1 >= 0.5;
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) stars += '<i class="fas fa-star"></i>';
                else if (i === fullStars && hasHalf) stars += '<i class="fas fa-star-half-alt"></i>';
                else stars += '<i class="far fa-star"></i>';
            }
            return stars;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('fr-FR').format(price);
        }

        // Filtres unifi√©s
        function setupFilters() {
            const profSearch = document.getElementById('prof-search');
            if (profSearch) {
                profSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filtered = allProfCourses.filter(cours => 
                        cours.titre_cours.toLowerCase().includes(searchTerm) ||
                        (cours.desc_cours || '').toLowerCase().includes(searchTerm)
                    );
                    renderProfCourses(filtered, document.getElementById('liste'));
                });
            }

            const explorerSearch = document.getElementById('explorer-search');
            const explorerNiveau = document.getElementById('explorer-niveau');
            const applyExplorerFilters = () => {
                const searchTerm = explorerSearch.value.toLowerCase();
                const niveau = explorerNiveau.value.toLowerCase();
                const filtered = allExplorerCourses.filter(cours => {
                    const matchSearch = !searchTerm || 
                        cours.titre_cours.toLowerCase().includes(searchTerm) ||
                        (cours.desc_cours || '').toLowerCase().includes(searchTerm);
                    const matchNiveau = !niveau || (cours.niveau_nom || '').toLowerCase() === niveau;
                    return matchSearch && matchNiveau;
                });
                renderExplorerCourses(filtered, document.getElementById('explorer-liste'));
            };
            if (explorerSearch) explorerSearch.addEventListener('input', applyExplorerFilters);
            if (explorerNiveau) explorerNiveau.addEventListener('change', applyExplorerFilters);
        }

        function setupLogout() {
            document.getElementById('btn-logout').addEventListener('click', async () => {
                try {
                    const response = await fetch('/user/logout', { method: 'POST', credentials: 'include' });
                    if (response.ok) {
                        alert('D√©connexion r√©ussie');
                        window.location.href = '/user/login';
                    }
                } catch (error) {
                    alert('Erreur d√©connexion');
                }
            });
        }

        // ‚úÖ Initialisation compl√®te
        function initializeDashboard() {
            setNavLinks(currentUser.roles_id);
            const defaultTab = currentUser.roles_id === 1 ? 'dash-etudiant' : 'dash-prof';
            showTab(defaultTab);
            showUserInfo(currentUser);
            setupFilters();
            setupLogout();


            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const tab = link.dataset.tab;
                    showTab(tab);
                    
                    if (tab === 'cours-crud') await fetchCoursProf();
                    if (tab === 'explorer' || tab === 'cours') {
                        await 
                        fetchCours();
                        fetchCoursEtudiant();
                        // courseActions(); // ‚úÖ R√©attacher apr√®s fetch
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', fetchUserData);
    </script>
</body>
</html>