<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - AcademiaLMS</title>
    <!-- Vos liens CSS -->
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <span>Academia<span class="logo-highlight">LMS</span></span>
        </div>
        <nav class="admin-nav" id="nav-links">
            <!-- Navigation dynamique -->
        </nav>
        <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i><span>Déconnexion</span>
        </button>
    </aside>

    <main class="main-content">
        <!-- Dashboard Étudiant -->
        <section class="tab-content" id="dash-etudiant" style="display:none;">
            <div class="header"><h2><i class="fas fa-tachometer-alt"></i> Dashboard Étudiant</h2></div>
            <div class="stats-section">
                <h3>Vos statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-book"></i></div><h4>Cours Actifs</h4><p>12</p></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-clock"></i></div><h4>Heures</h4><p>45h</p></div>
                </div>
            </div>
        </section>

        <!-- Cours Étudiant -->
        <section class="tab-content" id="cours" style="display:none;">
            <div class="header"><h2><i class="fas fa-book-open"></i> Mes Cours</h2></div>
            <div id="etudiant-cours-list">Chargement de vos cours...</div>
        </section>

        <!-- Explorer Étudiant -->
        <section class="tab-content" id="explorer" style="display:none;">
            <div class="header"><h2><i class="fas fa-search"></i> Explorer</h2></div>
            <div>Rechercher et découvrir de nouveaux cours...</div>
        </section>

        <!-- Dashboard Professeur -->
        <section class="tab-content" id="dash-prof" style="display:none;">
            <div class="header"><h2><i class="fas fa-chalkboard-teacher"></i> Dashboard Professeur</h2></div>
            <div class="stats-section">
                <h3>Statistiques</h3>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-book"></i></div><h4>Cours Créés</h4><p>8</p></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div><h4>Étudiants</h4><p>247</p></div>
                </div>
            </div>
        </section>

        <!-- Gestion Cours CRUD Prof -->
        <section class="tab-content" id="cours-crud" style="display:none;">
            <div class="header"><h2><i class="fas fa-book"></i> Gestion Cours</h2></div>
            <button class="add-course-btn" id="addCourseBtn"><i class="fas fa-plus"></i> Nouveau Cours</button>
            <div id="prof-cours-list">Chargement de vos cours...</div>
        </section>

        <!-- Compte (commun) -->
        <section class="tab-content" id="compte" style="display:none;">
            <div class="header"><h2><i class="fas fa-user-circle"></i> Mon Compte</h2></div>
            <div class="account-section">
                <div class="account-avatar"><i class="fas fa-user"></i></div>
                <div class="account-info">
                    <h3 id="user-name">Chargement...</h3>
                    <p class="account-email" id="user-email">-</p>
                </div>
                <div class="account-details">
                    <div class="detail-row"><label>Téléphone</label><span id="user-phone">-</span></div>
                    <div class="detail-row"><label>Rôle</label><span id="user-role">-</span></div>
                    <div class="detail-row"><label>Membre depuis</label><span id="user-date">-</span></div>
                </div>
            </div>
        </section>
    </main>

    <script>
        let currentUser = null;
        let isLoadingUser = true;

        // Récupérer les infos utilisateur depuis le backend
        async function fetchUserData() {
            try {
                const response = await fetch('authRoutes/getUserSession', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                } else {
                    // Rediriger vers login si pas connecté
                    window.location.href = '/login';
                    return;
                }
            } catch (error) {
                console.error('Erreur fetch user:', error);
                window.location.href = '/login';
                return;
            }
            
            isLoadingUser = false;
            initializeDashboard();
        }

        function setNavLinks(role) {
            const navLinks = document.getElementById('nav-links');
            if (role === 1) { // Étudiant
                navLinks.innerHTML = `
                    <a href="#" class="nav-link active" data-tab="dash-etudiant">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a href="#" class="nav-link" data-tab="cours">
                        <i class="fas fa-book-open"></i> Cours
                    </a>
                    <a href="#" class="nav-link" data-tab="explorer">
                        <i class="fas fa-search"></i> Explorer
                    </a>
                    <a href="#" class="nav-link" data-tab="compte">
                        <i class="fas fa-user-circle"></i> Compte
                    </a>
                `;
            } else if (role === 2) { // Professeur
                navLinks.innerHTML = `
                    <a href="#" class="nav-link active" data-tab="dash-prof">
                        <i class="fas fa-chalkboard-teacher"></i> Dashboard
                    </a>
                    <a href="#" class="nav-link" data-tab="cours-crud">
                        <i class="fas fa-book"></i> Gestion Cours
                    </a>
                    <a href="#" class="nav-link" data-tab="compte">
                        <i class="fas fa-user-circle"></i> Compte
                    </a>
                `;
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = tab.id === tabId ? 'block' : 'none';
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.tab === tabId);
            });
        }

        function showUserInfo(user) {
            document.getElementById('user-name').textContent = `${user.nom} ${user.prenom}`;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-phone').textContent = user.tel || 'Non renseigné';
            document.getElementById('user-role').textContent = user.roles_id === 1 ? 'Étudiant' : 'Professeur';
            document.getElementById('user-date').textContent = user.membreDepuis || new Date().toLocaleDateString('fr-FR');
        }

        function initializeDashboard() {
            setNavLinks(currentUser.roles_id);
            
            // Afficher le bon dashboard par défaut
            const defaultTab = currentUser.roles_id === 1 ? 'dash-etudiant' : 'dash-prof';
            showTab(defaultTab);
            
            showUserInfo(currentUser);
            
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    showTab(link.dataset.tab);
                });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await fetch('/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    window.location.href = '/login';
                }
            });
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', fetchUserData);
    </script>
</body>
</html>
