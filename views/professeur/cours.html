<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des cours</title>
    <link rel="stylesheet" href="/stylesheets/cours.css">
</head>
<body>
    <!-- üé® CONTENEUR PRINCIPAL -->
    <div class="container">
        <!-- üìù FORMULAIRE CR√âATION/MODIFICATION COURS -->
        <div class="cours_form">
            <h2>Ajouter un nouveau cours</h2>
            <!-- üö® Zone messages d'erreur -->
            <div id="error-container"></div>
            
            <!-- üì§ FORMULAIRE (POST par d√©faut, PUT en mode √©dition) -->
            <form id="cours" action="/professeur/cours" method="post">
                
                <!-- 1Ô∏è‚É£ TITRE -->
                <div class="input-group">
                    <label for="titre_cours">Titre du cours</label>
                    <input type="text" id="titre_cours" name="titre_cours" required>
                </div>

                <!-- 2Ô∏è‚É£ DESCRIPTION -->
                <div class="input-group">
                    <label for="desc_cours">Description du cours</label>
                    <textarea id="desc_cours" name="desc_cours" required></textarea>
                </div>

                <!-- 3Ô∏è‚É£ PRIX -->
                <div class="input-group">
                    <label for="prix">Prix du cours (Fcfa)</label>
                    <input type="number" id="prix" name="prix" step="0.01" min="0" required>
                </div>

                <!-- 4Ô∏è‚É£ DUR√âE -->
                <div class="input-group">
                    <label for="duree_minutes">Dur√©e en minutes</label>
                    <input type="number" id="duree_minutes" name="duree_minutes" min="1" required>
                </div>

                <!-- 5Ô∏è‚É£ PR√â-REQUIS -->
                <div class="input-group">
                    <label for="pre_requis">Pr√©-requis du cours</label>
                    <textarea id="pre_requis" name="pre_requis" required></textarea>
                </div> 

                <!-- 6Ô∏è‚É£ CAT√âGORIE (dropdown charg√© dynamiquement) -->
                <div class="input-group">
                    <label for="categories_id">Cat√©gorie</label>
                    <div class="select">
                        <select id="categories_id" name="categories_id" required>
                            <option value="">Chargement des cat√©gories...</option>
                        </select>
                    </div>
                </div> 

                <!-- 7Ô∏è‚É£ NIVEAU (dropdown charg√© dynamiquement) -->
                <div class="input-group">
                    <label for="niveau_id">Niveau</label>
                    <div class="select">
                        <select id="niveau_id" name="niveau_id" required>
                            <option value="">Chargement des niveau...</option>
                        </select>
                    </div>
                </div> 

                <!-- üöÄ BOUTON SOUMISSION -->
                <button type="submit" class="btn">Ajouter le cours</button>
            </form>
        </div>
    </div>

    <script>
        async function loadCategories() {
            try {

                const response = await fetch('/categories', {
                    method: 'GET',
                    credentials: 'include',  
                });
                const data = await response.json();

                const select = document.getElementById('categories_id');

                if (!data.success) {
                    console.error('Erreur cat√©gories:', data.message);
                    select.innerHTML = '<option value="">Erreur de chargement</option>';
                    return;
                }

                select.innerHTML = '<option value="">S√©lectionner une cat√©gorie</option>';

                data.categories.forEach((category) => {
                    const option = document.createElement('option');
                    option.value = category.id; 
                    option.textContent = category.nom_cat; 
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Erreur fetch cat√©gories:', err);
            }
        }

        async function loadNiveaux() {
            try {
                const response = await fetch('/niveau', {
                    method: 'GET',
                    credentials: 'include',
                });
                const data = await response.json();

                const select = document.getElementById('niveau_id');

                if (!data.success) {
                    console.error('Erreur niveau:', data.message);
                    select.innerHTML = '<option value="">Erreur de chargement</option>';
                    return;
                }

                select.innerHTML = '<option value="">S√©lectionner un niveau</option>';

                data.niveaux.forEach((niveau) => {
                    const option = document.createElement('option');
                    option.value = niveau.id; 
                    option.textContent = niveau.nom; 
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Erreur fetch niveaux:', err);
            }
        }

        const error = new URLSearchParams(window.location.search).get('error');
        if (error) {
            const messages = {
                server_error: "Erreur serveur, r√©essayez plus tard.",
                cours_exists: "Nom de cours d√©ja existant.",
                cours_created: "Cours cr√©√© avec succ√®s."
            };
            const container = document.getElementById('error-container');
            container.innerHTML = `<div id="error-message">${messages[error] || "Erreur inconnue."}</div>`;
        }

        let isEditMode = false;     
        let editCoursId = null;     

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit');

        if (editId) {
            console.log('üîÑ Mode √©dition activ√© pour cours ID:', editId);
            isEditMode = true;
            editCoursId = editId;
        }

        function loadCoursForEdit() {
            
            const coursData = sessionStorage.getItem('editCours');
            
            if (!coursData) {
                alert('Erreur : donn√©es du cours non trouv√©es');
                window.location.href = '/dashboard';
                return;
            }

            const cours = JSON.parse(coursData);
            console.log('üìù Chargement cours pour √©dition:', cours);

            // CHANGER INTERFACE MODE √âDITION
            const pageTitle = document.querySelector('h2');
            if (pageTitle) {
                pageTitle.textContent = 'Modifier le cours';  
            }

            const submitBtn = document.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Mettre √† jour le cours';  // üëà "Ajouter" ‚Üí "Mettre √† jour"
            }

            document.getElementById('titre_cours').value = cours.titre_cours || '';
            document.getElementById('desc_cours').value = cours.desc_cours || '';
            document.getElementById('prix').value = cours.prix || '';
            document.getElementById('duree_minutes').value = cours.duree_minutes || '';
            document.getElementById('pre_requis').value = cours.pre_requis || '';

            setTimeout(() => {
                document.getElementById('categories_id').value = cours.categories_id || '';
                document.getElementById('niveau_id').value = cours.niveau_id || '';
            }, 600);

            sessionStorage.removeItem('editCours');
        }

        async function updateCours() {
            // üì¶ Collecte toutes les donn√©es du formulaire
            const formData = {
                titre_cours: document.getElementById('titre_cours').value,
                desc_cours: document.getElementById('desc_cours').value,
                prix: parseFloat(document.getElementById('prix').value),
                duree_minutes: parseInt(document.getElementById('duree_minutes').value),
                pre_requis: document.getElementById('pre_requis').value,
                categories_id: parseInt(document.getElementById('categories_id').value),
                niveau_id: parseInt(document.getElementById('niveau_id').value)
            };

            console.log('üì§ Envoi mise √† jour cours ID:', editCoursId);
            console.log('üì¶ Donn√©es:', formData);

            try {
                const response = await fetch(`/cours/${editCoursId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'  
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData) 
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    console.log('‚úÖ Cours mis √† jour avec succ√®s');
                    alert('‚úÖ Cours mis √† jour avec succ√®s !');
                    window.location.href = '/dashboard';
                } else {
                    console.error('‚ùå Erreur:', data.message);
                    alert('‚ùå Erreur : ' + data.message);
                }
            } catch (error) {
                console.error('‚ùå Erreur mise √† jour:', error);
                alert('‚ùå Erreur lors de la mise √† jour du cours');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadNiveaux();

            if (isEditMode) {
                loadCoursForEdit();
            }

            const form = document.getElementById('cours');
            
            if (form) {
                form.addEventListener('submit', async (e) => {
                    if (isEditMode) {
                        e.preventDefault(); // ‚ùå Bloque POST normal
                        console.log('Interception soumission pour modification');
                        await updateCours(); // ‚úÖ PUT √† la place
                    }
                });
            }
        });
    </script>
</body>
</html>
